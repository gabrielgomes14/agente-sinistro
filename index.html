<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Plataforma de An√°lise de Sinistros por IA</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  
  const firebaseConfig = {
    apiKey: "AIzaSyB7e1IpR2l0wvxPE0vdkUGXO6PT74cKSu4",
    authDomain: "ecar-agente.firebaseapp.com",
    projectId: "ecar-agente",
    storageBucket: "ecar-agente.appspot.com",
    messagingSenderId: "894019220547",
    appId: "1:894019220547:web:af042385f29544e2a810f6",
    measurementId: "G-1J4W027QZM"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  window.auth = auth;
  window.db = db;
  window.GoogleAuthProvider = GoogleAuthProvider;
  window.signInWithPopup = signInWithPopup;
  window.signOut = signOut;
  window.onAuthStateChanged = onAuthStateChanged;
  window.collection = collection;
  window.addDoc = addDoc;
  window.query = query;
  window.onSnapshot = onSnapshot;
  window.orderBy = orderBy;
  window.serverTimestamp = serverTimestamp;
  window.doc = doc;
  window.deleteDoc = deleteDoc;

  initializeAppState();
</script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');

  :root {
    --bg-color: #0d1117;
    --surface-color: #161b22;
    --input-color: #0d1117;
    --primary-text-color: #e6edf3;
    --secondary-text-color: #848d97;
    --border-color: #30363d;
    --accent-color-1: #38bdf8;
    --accent-color-2: #818cf8;
    --gradient: linear-gradient(45deg, var(--accent-color-1), var(--accent-color-2));
    --success-color: #22c55e;
    --danger-color: #ef4444;
    --shadow-color: rgba(0, 0, 0, 0.4);
    --shadow-glow: rgba(56, 189, 248, 0.1);
  }

  body.light-mode {
    --bg-color: #f8fafc;
    --surface-color: #ffffff;
    --input-color: #f1f5f9;
    --primary-text-color: #0f172a;
    --secondary-text-color: #64748b;
    --border-color: #e2e8f0;
    --shadow-color: rgba(15, 23, 42, 0.08);
    --shadow-glow: rgba(56, 189, 248, 0.15);
  }
  
  @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes backgroundPan { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

  body {
    font-family: 'Inter', sans-serif;
    background-color: var(--bg-color);
    color: var(--primary-text-color);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 30px 20px; /* <-- DIST√ÇNCIA ALTERADA AQUI */
    box-sizing: border-box;
    transition: background-color 0.4s, color 0.4s;
    overflow-x: hidden;
    position: relative;
  }

  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: linear-gradient(135deg, rgba(56, 189, 248, 0.1), var(--bg-color), rgba(129, 140, 248, 0.1));
    background-size: 200% 200%;
    animation: backgroundPan 15s ease infinite;
    z-index: -1;
    transition: opacity 0.4s;
  }
  body.light-mode::before {
    opacity: 0.5;
  }
  
  .container {
    background-color: var(--surface-color);
    max-width: 750px;
    width: 100%;
    padding: 40px;
    border-radius: 24px;
    border: 1px solid var(--border-color);
    position: relative;
    transition: all 0.4s;
    box-shadow: 0 10px 40px var(--shadow-color), 0 0 0 1px var(--border-color);
    animation: fadeIn 0.6s ease-out forwards;
    z-index: 1;
  }
  
  .theme-toggle-button {
    position: absolute; top: 20px; right: 20px; background-color: var(--surface-color);
    border: 1px solid var(--border-color); color: var(--secondary-text-color);
    width: 44px; height: 44px; border-radius: 50%; cursor: pointer; font-size: 20px;
    display: flex; justify-content: center; align-items: center; transition: all 0.3s ease;
    z-index: 10;
  }
  .theme-toggle-button:hover { transform: scale(1.1) rotate(-15deg); border-color: var(--accent-color-1); box-shadow: 0 0 15px var(--shadow-glow); }
  .theme-toggle-button .icon-sun, .theme-toggle-button .icon-moon { position: absolute; transition: opacity 0.3s, transform 0.3s; }
  .theme-toggle-button .icon-sun { opacity: 0; transform: rotate(-90deg); }
  .theme-toggle-button .icon-moon { opacity: 1; transform: rotate(0deg); }
  body.light-mode .theme-toggle-button .icon-sun { opacity: 1; transform: rotate(0deg); }
  body.light-mode .theme-toggle-button .icon-moon { opacity: 0; transform: rotate(90deg); }

  #login-view { text-align: center; padding: 60px 20px; }
  
  .login-logo {
    width: 250px;
    height: auto;
    margin: 0 auto 30px auto;
  }

  body:not(.light-mode) .login-logo {
     /* filter: invert(1) brightness(2); */
  }

  #login-view h2 { margin-bottom: 15px; font-size: 2.25rem; }
  #login-view p { color: var(--secondary-text-color); margin-bottom: 40px; max-width: 450px; margin-left: auto; margin-right: auto; line-height: 1.6;}
  .google-login-button {
    display: inline-flex; align-items: center; padding: 14px 28px;
    background-image: linear-gradient(to right, #4285F4, #34A853, #FBBC05, #EA4335);
    color: white; border: none; border-radius: 12px;
    font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.3s;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  }
  .google-login-button:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25); }
  .google-login-button svg { width: 24px; height: 24px; margin-right: 15px; }

  .app-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 40px; 
    padding-bottom: 20px; 
    border-bottom: 1px solid var(--border-color);
    padding-right: 60px;
    position: relative;
  }

  .user-info { display: flex; align-items: center; }
  .user-info img { width: 44px; height: 44px; border-radius: 50%; margin-right: 15px; border: 2px solid var(--accent-color-2); }
  .user-info span { font-weight: 700; font-size: 1.1rem; }
  .logout-button {
    background: transparent; color: var(--secondary-text-color); border: 1px solid var(--border-color);
    padding: 10px 20px; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: 500;
  }
  .logout-button:hover { background-color: var(--danger-color); color: #fff; border-color: var(--danger-color); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); }

  h2 {
    text-align: center; font-size: 2.5rem; font-weight: 800; background: var(--gradient);
    -webkit-background-clip: text; background-clip: text; color: transparent;
    margin-top: 0; margin-bottom: 50px; letter-spacing: -1px;
  }
  .form-group { margin-bottom: 30px; }
  label {
    display: block; font-weight: 500; margin-bottom: 12px; color: var(--secondary-text-color);
    font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.8px;
  }
  input[type="text"], input[type="number"], textarea {
    width: 100%; box-sizing: border-box; padding: 16px 20px; font-size: 1rem;
    border-radius: 12px; border: 1px solid var(--border-color); background-color: var(--input-color);
    color: var(--primary-text-color); transition: all 0.3s ease;
  }
  input:focus, textarea:focus {
    outline: none; border-color: var(--accent-color-1); box-shadow: 0 0 0 4px var(--shadow-glow);
  }
  
  .file-input-wrapper {
    position: relative;
    width: 100%;
    background-color: var(--input-color);
    border: 2px dashed var(--border-color);
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    padding: 40px 20px;
    box-sizing: border-box;
  }

  .file-input-wrapper.is-dragging, .file-input-wrapper:hover { border-color: var(--accent-color-1); background-color: var(--surface-color); transform: scale(1.02); }
  .file-input-wrapper::before { content: 'üñºÔ∏è'; font-size: 3rem; margin-bottom: 15px; filter: grayscale(50%); transition: filter 0.3s, transform 0.3s; }
  .file-input-wrapper:hover::before { filter: grayscale(0%); transform: scale(1.1); }
  .file-input-wrapper span { color: var(--secondary-text-color); font-weight: 500; font-size: 1.1rem; }
  #inputImagem { opacity: 0; position: absolute; width: 100%; height: 100%; cursor: pointer; }
  
  .image-preview-container { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
  .image-preview { width: 90px; height: 90px; border-radius: 12px; object-fit: cover; border: 2px solid var(--border-color); animation: fadeIn 0.4s; transition: transform 0.3s; }
  .image-preview:hover { transform: scale(1.05); }

  .relato-wrapper { position: relative; }
  #mic-button {
    position: absolute; right: 10px; top: 10px; width: 44px; height: 44px;
    background-color: var(--input-color); border: 1px solid var(--border-color); border-radius: 50%;
    cursor: pointer; font-size: 22px; color: var(--secondary-text-color); 
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s;
  }
  #mic-button:hover { transform: scale(1.1); border-color: var(--accent-color-2); color: var(--accent-color-2); }
  #mic-button.is-recording { color: #fff; background-color: var(--danger-color); border-color: var(--danger-color); animation: pulse 1.5s infinite; }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

  .main-button {
    padding: 18px 24px; margin-top: 20px; cursor: pointer; width: 100%; font-size: 1.1rem;
    font-weight: 700; background-image: var(--gradient); border: none; color: #fff;
    border-radius: 12px; transition: transform 0.3s ease, box-shadow 0.3s ease;
    background-size: 200% auto;
  }
  .main-button:disabled { cursor: not-allowed; opacity: 0.5; filter: grayscale(80%); }
  .main-button:hover:not(:disabled) { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(56, 189, 248, 0.3); background-position: right center; }
  
  #resultado { margin-top: 50px; padding: 0; background: transparent; border: none; }
  .report-section { 
      background: var(--input-color);
      border: 1px solid var(--border-color);
      padding: 30px; margin-bottom: 25px; 
      border-radius: 16px;
      animation: fadeIn 0.5s ease-out forwards;
      transition: transform 0.3s, box-shadow 0.3s;
  }
  .report-section:hover { transform: translateY(-5px); box-shadow: 0 8px 30px var(--shadow-color); }
  #resultado h3 { 
      font-size: 1.5rem; font-weight: 700; margin-top: 0;
      margin-bottom: 25px; display: flex; align-items: center; gap: 12px;
      border-bottom: 1px solid var(--border-color); padding-bottom: 20px;
  }
  #resultado h3::before { font-size: 1.8rem; }
  h3.resumo::before { content: 'üìä'; }
  h3.descricao::before { content: 'üîç'; }
  h3.pecas::before { content: '‚öôÔ∏è'; }
  h3.tempo::before { content: '‚è≥'; }
  h3.coerencia::before { content: 'ü§ù'; }

  .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; }
  .summary-item { background-color: var(--surface-color); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--border-color); transition: transform 0.3s; }
  .summary-item:hover { transform: scale(1.05); }
  .summary-item strong { display: block; color: var(--secondary-text-color); font-size: 0.9rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.8px; }
  .summary-item span { font-weight: 700; font-size: 1.5rem; background: var(--gradient); -webkit-background-clip: text; background-clip: text; color: transparent; }
  
  .parts-list { list-style: none; padding: 0; margin: 0; }
  .parts-list li { display: flex; justify-content: space-between; align-items: center; padding: 15px 10px; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; border-radius: 8px; }
  .parts-list li:last-child { border-bottom: none; }
  .parts-list li:hover { background-color: var(--surface-color); }
  .parts-list li span { font-weight: 700; background: var(--surface-color); padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border-color); color: var(--accent-color-1); }

  .total-cost { text-align: right; font-size: 1.8rem; font-weight: 800; margin-top: 25px; }
  .total-cost span { background: var(--gradient); -webkit-background-clip: text; background-clip: text; color: transparent; }
  
  #history-section { margin-top: 50px; }
  #history-section h3 { text-align: center; color: var(--secondary-text-color); margin-bottom: 25px; font-weight: 500; text-transform: uppercase; letter-spacing: 1.5px; }
  .history-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
  
  .history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    padding: 0 0 0 20px;
    border-radius: 12px; 
    margin-bottom: 12px;
    background-color: var(--input-color);
  }
  .history-item-content {
    flex-grow: 1;
    cursor: pointer;
    padding: 20px 0;
  }
  .delete-history-button {
    background-color: transparent;
    border: none;
    border-left: 1px solid var(--border-color);
    color: var(--secondary-text-color);
    width: 60px;
    height: 100%;
    cursor: pointer;
    font-size: 1.5rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.3s ease;
    border-radius: 0 12px 12px 0;
  }
  .delete-history-button:hover {
    background-color: var(--danger-color);
    color: #fff;
    transform: scale(1.05);
  }

  #loading-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(13, 17, 23, 0.85); backdrop-filter: blur(8px);
    display: flex; flex-direction: column;
    justify-content: center; align-items: center; z-index: 1000;
    visibility: hidden; opacity: 0; transition: opacity 0.4s;
  }
  #loading-overlay.visible { visibility: visible; opacity: 1; }
  .spinner {
    width: 60px; height: 60px; border: 6px solid var(--border-color);
    border-top-color: var(--accent-color-1); border-left-color: var(--accent-color-2); border-radius: 50%;
    animation: spin 1.2s linear infinite;
  }
  #loading-overlay p { color: #fff; margin-top: 25px; font-weight: 500; font-size: 1.1rem; }

  @media (max-width: 600px) {
    body {
      padding: 30px 15px;
    }
    .container {
      padding: 20px;
    }
    h2, #login-view h2 {
      font-size: 1.9rem;
      margin-bottom: 30px;
    }
    #login-view {
      padding: 30px 10px;
    }
    .login-logo {
      width: 120px;
    }
    
    .main-button, .google-login-button {
      padding: 16px 20px;
      font-size: 1rem;
    }
    #resultado h3 {
      font-size: 1.2rem;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }
    .report-section {
      padding: 20px;
    }
    .summary-item span {
      font-size: 1.2rem;
    }
    .total-cost {
      font-size: 1.5rem;
    }
    .history-item {
      padding: 0;
      flex-direction: column;
      align-items: stretch;
      gap: 0;
    }
    .history-item-content {
      padding: 15px;
    }
    .delete-history-button {
      width: 100%;
      border-radius: 0 0 12px 12px;
      border-left: none;
      border-top: 1px solid var(--border-color);
      padding: 10px 0;
      font-size: 1rem;
      height: auto;
    }
    .delete-history-button:hover {
        transform: none;
    }
  }
</style>
</head>
<body>

<div id="loading-overlay">
  <div class="spinner"></div>
  <p>A IA est√° a analisar... Por favor, aguarde.</p>
</div>

<div class="container">
  <button id="theme-toggle" class="theme-toggle-button" aria-label="Toggle light/dark theme">
      <span class="icon-moon">üåô</span>
      <span class="icon-sun">‚òÄÔ∏è</span>
  </button>
  
  <div id="login-view">
    <img src="/images/fleet.png" alt="Logo da Empresa" class="login-logo">
    
    <h2>Bem-vindo √† Plataforma de An√°lise de Sinistros</h2>
    <p>Fa√ßa login com a sua conta Google para aceder ao hist√≥rico e guardar as suas an√°lises.</p>
    <button class="google-login-button" onclick="signInWithGoogle()">
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,5 12,5C14.6,5 16.1,6.05 17.1,7.05L19.27,4.92C17.07,2.92 14.5,2 12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.5,22 21.5,18.15 21.5,12.33C21.5,11.76 21.45,11.43 21.35,11.1Z"></path></svg>
      Login com Google
    </button>
  </div>

  <div id="app-view" style="display: none;">
    <div class="app-header">
      <div class="user-info">
        <img id="user-photo" src="" alt="Foto do Utilizador">
        <span id="user-name"></span>
      </div>
      <button class="logout-button" onclick="signOutUser()">Sair</button>
    </div>
    
    <h2>An√°lise de Sinistro por IA</h2>

    <div class="form-group">
        <label for="inputImagem">Imagens do Dano</label>
        <div class="file-input-wrapper">
            <span id="file-name">Clique ou arraste as imagens aqui</span>
            <input type="file" id="inputImagem" accept="image/*" multiple />
        </div>
        <div class="image-preview-container" id="image-preview-container"></div>
    </div>
    <div class="form-group">
        <label for="localizacao">Cidade / Estado para Cota√ß√£o</label>
        <input type="text" id="localizacao" placeholder="Ex: S√£o Paulo, SP" />
    </div>
    <div class="form-group">
        <label for="modelo">Modelo do Carro</label>
        <input type="text" id="modelo" placeholder="Ex: Fiat Argo" />
    </div>
    <div class="form-group">
        <label for="ano">Ano do Carro</label>
        <input type="number" id="ano" min="1900" max="2100" placeholder="Ex: 2023" />
    </div>
    <div class="form-group">
        <label for="relato">Relato do Motorista</label>
        <div class="relato-wrapper">
          <textarea id="relato" rows="5" placeholder="Descreva o que o motorista relatou ou clique no microfone para falar..."></textarea>
          <button id="mic-button" onclick="toggleVoiceRecognition()">üéôÔ∏è</button>
        </div>
    </div>

    <button class="main-button" onclick="enviarDados()">Analisar e Gerar Relat√≥rio</button>

    <div id="resultado" style="display: none;"></div> 
    
    <button id="botaoImprimir" class="main-button" onclick="imprimirPDF()" style="display: none; margin-top: 0;">Imprimir An√°lise</button>
    
    <div id="history-section" style="display: none;">
      <h3>Hist√≥rico de An√°lises</h3>
      <ul class="history-list" id="history-list"></ul>
    </div>
  </div>
</div>

<script>
  let currentUser = null;
  let recognition = null;

  // --- THEME TOGGLE ---
  const themeToggleButton = document.getElementById('theme-toggle');
  const currentTheme = localStorage.getItem('theme');
  if (currentTheme === 'light') {
      document.body.classList.add('light-mode');
  }
  themeToggleButton.addEventListener('click', () => {
      document.body.classList.toggle('light-mode');
      let theme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
      localStorage.setItem('theme', theme);
  });

  // --- AUTHENTICATION ---
  window.initializeAppState = () => {
    window.onAuthStateChanged(window.auth, (user) => {
      if (user) {
        currentUser = user;
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('app-view').style.display = 'block';
        document.getElementById('user-name').textContent = user.displayName;
        document.getElementById('user-photo').src = user.photoURL;
        loadUserHistory(user.uid);
      } else {
        currentUser = null;
        document.getElementById('login-view').style.display = 'block';
        document.getElementById('app-view').style.display = 'none';
      }
    });
  };

  window.signInWithGoogle = () => {
    const provider = new window.GoogleAuthProvider();
    window.signInWithPopup(window.auth, provider).catch((error) => {
      console.error("Erro no login com Google:", error);
      alert("N√£o foi poss√≠vel fazer o login. Tente novamente.");
    });
  };

  window.signOutUser = () => {
    window.signOut(window.auth).catch((error) => {
      console.error("Erro ao sair:", error);
    });
  };

  // --- UI & FORM LOGIC ---
  const fileInputWrapper = document.querySelector('.file-input-wrapper');
  const fileInput = document.getElementById('inputImagem');

  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    fileInputWrapper.addEventListener(eventName, (e) => {
      e.preventDefault();
      e.stopPropagation();
    }, false);
  });
  ['dragenter', 'dragover'].forEach(eventName => {
    fileInputWrapper.addEventListener(eventName, () => fileInputWrapper.classList.add('is-dragging'), false);
  });
  ['dragleave', 'drop'].forEach(eventName => {
    fileInputWrapper.addEventListener(eventName, () => fileInputWrapper.classList.remove('is-dragging'), false);
  });
  fileInputWrapper.addEventListener('drop', (e) => {
    fileInput.files = e.dataTransfer.files;
    handleFileChange({ target: fileInput });
  }, false);

  fileInput.addEventListener('change', handleFileChange);

  function handleFileChange(event) {
      const previewContainer = document.getElementById('image-preview-container');
      const fileNameSpan = document.getElementById('file-name');
      previewContainer.innerHTML = '';
      
      const files = event.target.files;
      if (files.length > 0) {
          fileNameSpan.textContent = `${files.length} imagem(ns) selecionada(s)`;
          Array.from(files).forEach(file => {
              const img = document.createElement('img');
              img.classList.add('image-preview');
              img.src = URL.createObjectURL(file);
              img.onload = () => URL.revokeObjectURL(img.src);
              previewContainer.appendChild(img);
          });
      } else {
          fileNameSpan.textContent = 'Clique ou arraste as imagens aqui';
      }
  }

  // --- VOICE RECOGNITION ---
  window.toggleVoiceRecognition = () => {
    if (recognition && recognition.isRecording) {
      recognition.stop();
      return;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("O seu navegador n√£o suporta a funcionalidade de voz.");
      return;
    }
    
    recognition = new SpeechRecognition();
    recognition.lang = 'pt-BR';
    recognition.interimResults = true;
    recognition.isRecording = false;

    const micButton = document.getElementById('mic-button');
    const relatoTextarea = document.getElementById('relato');

    recognition.onstart = () => {
      recognition.isRecording = true;
      micButton.classList.add('is-recording');
      micButton.textContent = 'üî¥';
    };
    recognition.onend = () => {
      recognition.isRecording = false;
      micButton.classList.remove('is-recording');
      micButton.textContent = 'üéôÔ∏è';
    };
    recognition.onresult = (event) => {
      let transcript = '';
      for (let i = 0; i < event.results.length; i++) {
        transcript += event.results[i][0].transcript;
      }
      relatoTextarea.value = transcript;
    };
    
    recognition.start();
  };

  // --- CORE ANALYSIS & DATA HANDLING ---
  function showLoading(visible) {
    document.getElementById('loading-overlay').classList.toggle('visible', visible);
  }

  function extractJSON(str) {
      const firstBrace = str.indexOf('{');
      const lastBrace = str.lastIndexOf('}');
      if (firstBrace === -1 || lastBrace === -1 || lastBrace < firstBrace) {
        throw new Error("A resposta da IA n√£o continha um formato JSON v√°lido.");
      }
      return str.substring(firstBrace, lastBrace + 1);
  }

  window.enviarDados = async () => {
      if (!currentUser) {
        alert("Por favor, fa√ßa login para continuar.");
        return;
      }
      const files = document.getElementById('inputImagem').files;
      const localizacao = document.getElementById('localizacao').value.trim();
      const modelo = document.getElementById('modelo').value.trim();
      const ano = document.getElementById('ano').value.trim();
      const relato = document.getElementById('relato').value.trim();

      if (files.length === 0 || !localizacao || !modelo || !ano || !relato) {
        alert("Por favor, preencha todos os campos e selecione pelo menos uma imagem.");
        return;
      }
      
      showLoading(true);
      
      try {
        const formData = new FormData();
        for(const file of files) {
          formData.append('imagem', file);
        }
        formData.append('localizacao', localizacao);
        formData.append('modelo', modelo);
        formData.append('ano', ano);
        formData.append('relato_motorista', relato);

        const response = await fetch('https://ecar-agente-backend.onrender.com/analisar', {
            method: 'POST',
            body: formData,
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: 'Erro desconhecido no servidor.' }));
            throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        const jsonString = extractJSON(result.descricao);
        const data = JSON.parse(jsonString);
        
        document.getElementById('resultado').innerHTML = gerarRelatorioHTML(data);
        document.getElementById('resultado').style.display = 'block';
        document.getElementById('botaoImprimir').style.display = 'block';

        await saveReportToFirestore(data);

      } catch(e) {
        console.error("Erro ao analisar:", e);
        alert(`Erro ao analisar: ${e.message}`);
      } finally {
        showLoading(false);
      }
  };

  async function saveReportToFirestore(reportData) {
    if (!currentUser) return;
    try {
      await window.addDoc(window.collection(window.db, 'analyses', currentUser.uid, 'reports'), {
        ...reportData,
        createdAt: window.serverTimestamp(),
        carModel: `${document.getElementById('modelo').value} ${document.getElementById('ano').value}`
      });
    } catch (error) {
      console.error("Erro ao guardar no Firestore:", error);
    }
  }

  async function deleteReport(reportId) {
    if (!currentUser || !reportId) {
      console.error("Utilizador n√£o autenticado ou ID do relat√≥rio em falta.");
      return;
    }

    try {
      const reportRef = window.doc(window.db, 'analyses', currentUser.uid, 'reports', reportId);
      await window.deleteDoc(reportRef);
    } catch (error) {
      console.error("Erro ao excluir o relat√≥rio:", error);
      alert("N√£o foi poss√≠vel excluir o relat√≥rio. Tente novamente.");
    }
  }

  document.getElementById('history-list').addEventListener('click', (event) => {
    if (event.target.classList.contains('delete-history-button')) {
      const reportItem = event.target.closest('.history-item');
      const reportId = reportItem.dataset.id;

      if (confirm("Tem a certeza de que deseja excluir esta an√°lise? Esta a√ß√£o n√£o pode ser desfeita.")) {
        deleteReport(reportId);
      }
    }
  });
  
  function loadUserHistory(userId) {
    const historyList = document.getElementById('history-list');
    const historySection = document.getElementById('history-section');
    const q = window.query(
      window.collection(window.db, 'analyses', userId, 'reports'),
      window.orderBy('createdAt', 'desc')
    );

    window.onSnapshot(q, (querySnapshot) => {
      historyList.innerHTML = '';
      if (querySnapshot.empty) {
        historySection.style.display = 'none';
      } else {
        historySection.style.display = 'block';
        querySnapshot.forEach((doc) => {
          const report = doc.data();
          const li = document.createElement('li');
          li.classList.add('history-item');
          li.dataset.id = doc.id;
          
          li.innerHTML = `
            <div class="history-item-content">
              <span>${report.carModel} - Dano ${report.analiseGeral.nivelDano}</span>
              <time>${new Date(report.createdAt?.toDate()).toLocaleDateString()}</time>
            </div>
            <button class="delete-history-button" aria-label="Excluir item">&times;</button>
          `;

          li.querySelector('.history-item-content').onclick = () => {
            document.getElementById('resultado').innerHTML = gerarRelatorioHTML(report);
            document.getElementById('resultado').style.display = 'block';
            document.getElementById('botaoImprimir').style.display = 'block';
            window.scrollTo({ top: document.getElementById('resultado').offsetTop - 20, behavior: 'smooth' });
          };
          
          historyList.appendChild(li);
        });
      }
    });
  }

  window.gerarRelatorioHTML = (data) => {
      const custoTotal = data.pecasNecessarias.reduce((acc, peca) => acc + (peca.custo || 0), 0);
      let pecasHTML = '';
      data.pecasNecessarias.forEach(peca => {
          const custo = peca.custo || 0;
          pecasHTML += `<li>${peca.nome} <span>R$ ${custo.toFixed(2).replace('.',',')}</span></li>`;
      });
      return `
          <div class="report-section"><h3 class="resumo">Resumo da An√°lise</h3><div class="summary-grid"><div class="summary-item"><strong>N√≠vel do Dano</strong><span>${data.analiseGeral.nivelDano}</span></div><div class="summary-item"><strong>Urg√™ncia</strong><span>${data.analiseGeral.nivelUrgencia}</span></div><div class="summary-item" style="grid-column: 1 / -1;"><strong>√Årea Afetada</strong><span>${data.analiseGeral.areaVeiculo}</span></div></div></div>
          <div class="report-section"><h3 class="descricao">Descri√ß√£o Detalhada dos Danos</h3><p>${data.descricaoDanos}</p></div>
          <div class="report-section"><h3 class="pecas">Pe√ßas e Custos Estimados</h3><ul class="parts-list">${pecasHTML}</ul><div class="total-cost">CUSTO TOTAL: <span>R$ ${custoTotal.toFixed(2).replace('.',',')}</span></div></div>
          <div class="report-section"><h3 class="tempo">Tempo Estimado para Reparo</h3><p>${data.estimativas.tempoReparo}</p></div>
          <div class="report-section"><h3 class="coerencia">Coer√™ncia com Relato do Motorista</h3><p>${data.coerenciaRelato}</p></div>
      `;
  };

  window.imprimirPDF = async () => {
      const { jsPDF } = window.jspdf;
      const content = document.getElementById('resultado');
      const printButton = document.getElementById('botaoImprimir');
      
      printButton.disabled = true;
      printButton.textContent = 'A gerar PDF...';

      const originalDisplay = content.style.display;
      content.style.display = 'block';
      
      const lightMode = document.body.classList.contains('light-mode');

      try {
          const pdf = new jsPDF('p', 'mm', 'a4');
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const margin = 15;
          const contentWidth = pdfWidth - (margin * 2);
          
          let currentY = margin;

          const sections = content.querySelectorAll('.report-section');

          for (const section of sections) {
              const canvas = await html2canvas(section, {
                  scale: 2,
                  useCORS: true,
                  backgroundColor: lightMode ? '#ffffff' : '#161b22', 
              });

              const imgHeight = canvas.height * contentWidth / canvas.width;

              if (currentY + imgHeight > pdf.internal.pageSize.getHeight() - margin) {
                  pdf.addPage();
                  currentY = margin;
              }

              pdf.addImage(canvas, 'PNG', margin, currentY, contentWidth, imgHeight);
              
              currentY += imgHeight + 10;
          }

          const modelo = document.getElementById('modelo').value.trim().replace(/\s+/g, '_');
          const ano = document.getElementById('ano').value.trim();
          pdf.save(`analise_danos_${modelo}_${ano}.pdf`);

      } catch (error) {
          console.error("Erro ao gerar PDF:", error);
          alert("Ocorreu um erro ao gerar o PDF. Por favor, tente novamente.");
      } finally {
          content.style.display = originalDisplay;
          printButton.disabled = false;
          printButton.textContent = 'Imprimir An√°lise';
      }
  };
</script>

</body>
</html>